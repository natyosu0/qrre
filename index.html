<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>QR読み取り</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
text-align: center;
}
#codeBox {
margin-top: 10px;
font-size: 18px;
font-weight: bold;
#reader {
width: 320px;
height: 320px;
margin-top: 20px;
}  
</style>
</head>
<body>

<h3>QRコード読み取り</h3>

<div id="codebox">  
  製品番号：<span id="code"></span>
</div>
<h3>作業者名</h3>
<input type="text" id="inputData" placeholder="入力">
<br><br>
<input type="file" id="file">
<button onclick="writeExcel()">作業者名</button>

<button id="startBtn">カメラ起動</button>

<div id="reader"></div>

<script>
var qr = null;

document.getElementById("startBtn").onclick = function () {

if (qr !== null) {
    return;
}

qr = new Html5Qrcode("reader");

qr.start(
    { facingMode: "environment" }, // 背面カメラ
    {
    fps: 10,
    qrbox: 250
    },
function (decodedText) {
document.getElementById("code").innerText = decodedText;
},
function (errorMessage) {
}
).catch(function (err) {
alert("カメラを起動できません: " + err);
});
};

var workbook;
var worksheet;

document.getElementById("file").addEventListener("change", function(e){
var reader = new FileReader();
reader.onload = function(e){
var data = new Uint8Array(e.target.result);
workbook = XLSX.read(data, {type: "array"});
worksheet = workbook.Sheets[workbook.SheetNames[0]];
};
reader.readAsArrayBuffer(e.target.files[0]);
});

function writeExcel(){
    if (!worksheet) {
	    alert("ファイル選択");
		return;
	}
	
	var cellA2 = worksheet["A2"] ? String(worksheet["A2"].v) : "";
	
	if (cellA2 !== code){
	    alert("eroor");
	    return;
	}
	
    var value = document.getElementById("inputData").value;
	
    // A2セルに値を書き込み
    worksheet["B2"] = { t: "s", v: value };
	worksheet["!ref"] = "A1:B2";

    var newWb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(newWb, worksheet, "Sheet1");

    XLSX.writeFile(newWb, "updated.xlsx");
}

</script>

</body>
</html>
